# LocalNetScan

**高速並列ネットワークスキャナー** - Python Flask アプリケーション

## 概要

LocalNetScanは、ローカルネットワーク内の全サブネットを自動検出し、**10スレッド並列実行**で高速にホストをスキャンするWebアプリケーションです。Docker環境や複数ネットワーク範囲にも対応し、ネットワーク全体を視覚的に把握できます。

### 主な機能

#### 🚀 高速スキャン
- **10スレッド並列PINGスキャン**: 大規模ネットワーク（/16など）を高速スキャン
- **nmapの最適化オプション**: `-T4 --min-rate 300 --host-timeout 10s --max-retries 1` による大幅な速度改善
- **チャンク分割処理**: 大きなサブネットを/24チャンクに分割して並列実行

#### 🌐 ネットワーク検出
- **自動サブネット検出**: 192.168.x.x、172.x.x.x、10.x.x.x の全サブネットを自動検出
- **Dockerネットワーク対応**: Dockerブリッジネットワーク（172.17.0.0/16など）も検出
- **複数範囲スキャン**: カンマ区切りで複数ネットワークを同時スキャン（例: `192.168.0.0/24,172.17.0.0/16`）

#### 🔍 詳細情報取得
- **ポートスキャン**: 優先ポートスキャン（高速）と全ポートスキャン（6スレッド並列）
- **HTTP/HTTPS詳細情報**: サーバー情報、セキュリティヘッダー、タイトル取得（モーダル表示）
- **ネットワークトポロジー**: ホスト間の接続関係をグラフ可視化

#### 📊 リアルタイムUI
- **正確な進捗表示**: チャンク完了毎に更新される正確な進捗率と検出台数
- **見やすいレイアウト**: モーダル表示による詳細情報の確認

## なぜnmapを採用したのか

### 高速化を最優先に設計

LocalNetScanでは、大規模ネットワークのスキャンを**数分以内**に完了させるため、nmapを採用しています。

| 項目 | nmap | Python (scapy等) |
|------|------|------------------|
| **スキャン速度** | **高速**（-T4/-T5等で最適化） | 低〜中速（同期処理だと遅い） |
| **並列処理** | **標準搭載** | コード次第で実装可能 |
| **オプション・機能** | **豊富**（UDP/TCP/OS検出等） | 自作なら自由度高い |
| **設定・カスタマイズ** | コマンドorオプション指定 | Pythonで自在だが高度 |

#### 速度比較の具体例

**172.17.0.0/16（65,534ホスト）のスキャン:**
- **Pythonのみ（scapy等）**: 15〜30分以上
- **nmap（デフォルト）**: 約10〜15分
- **LocalNetScan（10スレッド並列 + 高速化オプション）**: **約3分** ⚡

### 採用した高速化技術

1. **nmapの最適化オプション**
   - `-T4`: 高速タイミング
   - `--min-rate 300`: 1秒あたり最低300パケット送信
   - `--host-timeout 10s`: ホストごとのタイムアウト10秒
   - `--max-retries 1`: 再試行回数を1回に制限

2. **10スレッド並列実行**
   - ThreadPoolExecutorによる並列処理
   - 大きなサブネットを/24チャンクに分割
   - 各チャンクを独立スレッドでスキャン

3. **スレッドセーフな結果統合**
   - threading.Lockによる安全な結果マージ
   - リアルタイムな進捗更新

## システム要件

- **Python**: 3.7 以上
- **nmap**: 7.0 以上（必須）
- **OS**: Linux、macOS、または Windows（WSL）

## 初期環境構築

### 手順1: nmapのインストール

| OS | コマンド | 備考 |
|----|----------|------|
| **Ubuntu/Debian** | `sudo apt-get update && sudo apt-get install nmap` | apt経由で最新版を取得 |
| **macOS** | `brew install nmap` | Homebrewが必要 |
| **Windows** | [nmap.org](https://nmap.org/download.html)からインストーラーをダウンロード | WSL環境推奨 |

**インストール確認:**
```bash
nmap --version
```

### 手順2: プロジェクトのセットアップ

| 手順 | コマンド | 説明 |
|------|----------|------|
| **1. リポジトリ移動** | `cd LocalNetScan` | プロジェクトディレクトリへ移動 |
| **2. 仮想環境作成**（推奨） | `python3 -m venv venv` | 独立したPython環境を作成 |
| **3. 仮想環境有効化** | `source venv/bin/activate`<br>（Windows: `venv\Scripts\activate`） | 仮想環境をアクティベート |
| **4. パッケージインストール** | `pip install -r requirements.txt` | 必要なPythonライブラリをインストール |

**requirements.txtの内容:**
```
Flask==3.0.0
python-nmap==0.7.1
Werkzeug==3.0.1
requests==2.31.0
networkx==3.2.1
```

### 手順3: アプリケーション起動

| 方法 | コマンド | 用途 |
|------|----------|------|
| **通常起動** | `python3 app.py` | 一般的なスキャン（-sT） |
| **sudo起動**（推奨） | `sudo python3 app.py` | SYNスキャン（-sS）で高速化 |

**起動成功時の表示:**
```
============================================================
LocalNetScan - ローカルネットワークスキャナー
============================================================
✓ アプリケーションを起動しています...
✓ ポート 5000 が利用可能です
✓ ブラウザで http://127.0.0.1:5000 にアクセスしてください
============================================================
```

## 使用方法

### 1. Webインターフェースにアクセス

ブラウザで以下のURLを開く:
```
http://127.0.0.1:5000
```

### 2. スキャンの実行

#### 自動検出スキャン
- 「ネットワークをスキャン」ボタンをクリック
- 自動的にすべてのサブネット（192.168.x.x, 172.x.x.x, 10.x.x.x）を検出してスキャン

#### カスタム範囲スキャン
入力フィールドに以下の形式で指定:

| 形式 | 例 | 説明 |
|------|----|----|
| **サブネット** | `192.168.0.0/24` | CIDR形式 |
| **IP範囲** | `192.168.0.1-50` | 範囲指定 |
| **複数範囲** | `192.168.0.0/24,172.17.0.0/16` | カンマ区切り |
| **Docker** | `172.17.0.0/16` | Dockerネットワーク |

### 3. 詳細機能

| 機能 | 操作 | 説明 |
|------|------|------|
| **ポートスキャン** | ホスト行の「ポートスキャン」ボタン | 優先ポートまたは全ポート（65535）をスキャン |
| **HTTP詳細** | オープンポートの「HTTP」アイコン | サーバー情報、セキュリティヘッダー表示 |
| **ネットワークマップ** | 「ネットワークマップ」ボタン | トポロジーをグラフ表示 |
| **ホスト削除** | ホスト行の「×」ボタン | 結果リストから削除 |

### 4. スキャン速度の目安

| ネットワーク規模 | ホスト数 | スキャン時間（目安） |
|----------------|---------|-------------------|
| /24（1サブネット） | 254 | 約5-10秒 |
| /16（256サブネット） | 65,534 | 約3-5分 |
| 複数範囲（3つの/24） | 762 | 約15-30秒 |

*実際の速度はネットワーク状況により変動します

## プロジェクト構造

```
LocalNetScan/
├── app.py                 # Flaskアプリケーション（API、バックグラウンドスキャン）
├── scanner.py             # ネットワークスキャン機能（並列処理、nmap実行）
├── requirements.txt       # Python依存関係
├── README.md             # このファイル
├── templates/
│   └── index.html        # メインUI（HTML）
└── static/
    ├── style.css         # スタイルシート
    └── script.js         # フロントエンド処理（進捗表示、モーダル等）
```

## API エンドポイント

### スキャン管理

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/api/scan` | POST | ネットワークスキャン開始 |
| `/api/scan-status` | GET | スキャン進捗状況取得 |
| `/api/results` | GET | スキャン結果取得 |

### ホスト詳細

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/api/port-scan/<host>` | POST | ポートスキャン実行 |
| `/api/port-scan/<host>` | GET | ポートスキャン結果取得 |
| `/api/http-info/<host>/<port>` | GET | HTTP詳細情報取得 |
| `/api/host/<host>` | DELETE | ホストを結果から削除 |

### ネットワーク情報

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/api/network-topology` | GET | ネットワークトポロジー取得 |
| `/api/process-info/<host>` | GET | プロセス情報取得（ローカルのみ） |

### 例: スキャン開始

**リクエスト:**
```bash
curl -X POST http://127.0.0.1:5000/api/scan \
  -H "Content-Type: application/json" \
  -d '{"target_range": "192.168.0.0/24,172.17.0.0/16"}'
```

**レスポンス:**
```json
{
  "status": "success",
  "message": "スキャンを開始しました",
  "target_range": "192.168.0.0/24,172.17.0.0/16"
}
```

### 例: 進捗確認

**リクエスト:**
```bash
curl http://127.0.0.1:5000/api/scan-status
```

**レスポンス:**
```json
{
  "is_scanning": true,
  "scan_progress": 45,
  "current_subnet": "172.17.0.0/16 をスキャン中... (チャンク 115/256)",
  "found_hosts": 12,
  "nmap_available": true
}
```

## 高速化の仕組み

### 1. サブネット分割とチャンク処理

大きなサブネット（例: 172.17.0.0/16）を256個の/24チャンクに分割:

```
172.17.0.0/16
  ├── 172.17.0.0/24   ─┐
  ├── 172.17.1.0/24   ─┤
  ├── 172.17.2.0/24   ─┤
  ├── ...             ─┼─ 10スレッドで並列処理
  ├── 172.17.253.0/24 ─┤
  ├── 172.17.254.0/24 ─┤
  └── 172.17.255.0/24 ─┘
```

### 2. スレッドプールによる並列実行

```python
# scanner.py の実装イメージ
with ThreadPoolExecutor(max_workers=10) as executor:
    futures = {
        executor.submit(scan_chunk, chunk): chunk
        for chunk in chunks
    }
    for future in as_completed(futures):
        results.update(future.result())
```

### 3. nmapの高速化オプション

```bash
nmap -sn -T4 --min-rate 300 --host-timeout 10s --max-retries 1 172.17.0.0/24
```

| オプション | 効果 |
|-----------|------|
| `-T4` | 高速タイミング（T5より安定） |
| `--min-rate 300` | 1秒あたり最低300パケット送信 |
| `--host-timeout 10s` | ホストごとのタイムアウト10秒 |
| `--max-retries 1` | 再試行1回に制限 |

### 速度改善の実例

**従来（シングルスレッド、デフォルトオプション）:**
- 172.17.0.0/16: 約15分
- 192.168.0.0/24: 約30秒

**改善後（10スレッド並列 + 高速化オプション）:**
- 172.17.0.0/16: **約3分**（約5倍高速）
- 192.168.0.0/24: **約5秒**（約6倍高速）

## トラブルシューティング

### nmapが見つからない

**症状:**
```
エラー: nmapがシステムにインストールされていません
```

**解決方法:**
1. nmapをインストール（上記「初期環境構築」参照）
2. インストール確認: `nmap --version`
3. アプリケーション再起動

### スキャンが遅い

**確認事項:**

| 項目 | 確認方法 | 改善策 |
|------|---------|--------|
| **nmapバージョン** | `nmap --version` | 7.0以上に更新 |
| **ネットワーク負荷** | 他の通信を確認 | 他の大容量通信を停止 |
| **スレッド数** | scanner.pyのmax_threads確認 | 10に設定されているか確認 |
| **高速化オプション** | scanner.pyのarguments確認 | `-T4 --min-rate 300`が含まれているか |

### 権限エラー

**症状:**
```
You requested a scan type which requires root privileges.
```

**解決方法:**

| 方法 | コマンド | 備考 |
|------|---------|------|
| **sudo実行** | `sudo python3 app.py` | SYNスキャン（-sS）で高速 |
| **Webから設定** | UI右上「⚙️設定」→sudoパスワード入力 | 起動後でも設定可能 |
| **TCPスキャン使用** | 自動的に-sTにフォールバック | 若干遅いが権限不要 |

### ポートが使用中

**症状:**
```
✗ エラー: 利用可能なポートが見つかりませんでした
```

**解決方法:**
1. 使用中のプロセス確認:
   ```bash
   lsof -i :5000
   ```
2. プロセス終了、またはポート変更（app.py:944行目の`ports_to_try`を編集）

### Dockerネットワークが検出されない

**確認方法:**
```bash
ip addr | grep 172
```

**解決方法:**
- Dockerが起動しているか確認: `docker ps`
- 手動でスキャン範囲を指定: `172.17.0.0/16`

## セキュリティに関する注意事項

### ⚠️ 重要な警告

| 項目 | 注意点 |
|------|--------|
| **法的責任** | ❌ 自分が管理しているネットワーク**のみ**スキャン<br>❌ 許可なく他者のネットワークをスキャンすることは**違法** |
| **アクセス制限** | デフォルトは`127.0.0.1`（ローカルホスト）のみ<br>本番環境では認証機能を追加すること |
| **root権限** | SYNスキャン（-sS）にはroot権限が必要<br>権限なしの場合は自動的にTCPスキャン（-sT）に切替 |
| **ネットワーク負荷** | 大規模スキャンはネットワークに負荷をかける<br>スキャン頻度を適切に管理すること |
| **機密情報** | スキャン結果には機密情報が含まれる可能性<br>結果の取り扱いに注意 |

### アクセス制限の有効化

app.py:912-922行目のコメントを解除:

```python
@app.before_request
def limit_remote_addr():
    """セキュリティ: ローカルホストからのアクセスのみ許可"""
    allowed_ips = ['127.0.0.1', 'localhost', '::1']
    client_ip = request.remote_addr

    # 本番環境ではこのコメントを解除
    if client_ip not in allowed_ips:
        return jsonify({'error': 'アクセス拒否'}), 403
```

## パフォーマンスチューニング

### さらなる高速化（上級者向け）

scanner.py:259行目の`--min-rate`を増やす:

```python
# デフォルト（安定重視）
nm.scan(hosts=chunk, arguments='-sn -T4 --min-rate 300 --host-timeout 10s --max-retries 1')

# 超高速化（ネットワーク負荷大）
nm.scan(hosts=chunk, arguments='-sn -T5 --min-rate 1000 --host-timeout 5s --max-retries 0')
```

**注意:** 過度な高速化はネットワークに大きな負荷をかけます

### スレッド数の調整

scanner.py:278行目の`max_threads`を変更:

```python
def ping_scan(self, subnet: str, progress_callback=None, max_threads: int = 20):  # 10→20
```

**推奨値:** CPU コア数の1-2倍程度

## ライセンス

このプロジェクトは教育目的で作成されています。商用利用する場合は、適切なライセンスを追加してください。

## 貢献

バグ報告や機能リクエストは、GitHubのIssuesで受け付けています。

## 免責事項

このソフトウェアは「現状のまま」提供され、いかなる保証もありません。使用によって生じた損害について、開発者は一切の責任を負いません。

---

**開発者向けメモ:**
- nmapの最適化については[Nmap Network Scanning](https://nmap.org/book/performance.html)を参照
- 並列処理の実装は[Python ThreadPoolExecutor](https://docs.python.org/3/library/concurrent.futures.html)を参照
